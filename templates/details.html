<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Details</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-black min-h-screen">

<!-- Taskleiste -->
<header class="fixed top-0 left-0 w-full h-20 bg-[#004080] z-50 flex items-center px-6">
    <h1 class="text-white text-xl font-semibold">
        Details
    </h1>
</header>

<!-- Content -->
<main class="pt-28 flex justify-center pb-20">
    <section class="bg-gray-400 w-4/5 max-w-4xl rounded-lg p-6 space-y-6">

        <!-- ================= Termindaten ================= -->
        <div class="bg-white rounded-md p-5 space-y-4">
            <h2 class="text-xl font-bold text-gray-800">Termindaten</h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">

                <div id="terminDiv" data-termin-id="{{ termin.id }}">
                    <label class="block font-medium text-gray-700">Terminart</label>
                    <select class="w-full border rounded px-3 py-2">
                        <option>Bitte ausw√§hlen</option>
                        {% for art in arten %}
                        <option value="{{ art.id }}" {% if art.id == termin.art_id %} selected="selected" {% endif %}>{{ art.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div>
                    <label class="block font-medium text-gray-700">Titel</label>
                    <input type="text" class="w-full border rounded px-3 py-2" value="{{ termin.title }}">
                </div>

                <div>
                    <label class="block font-medium text-gray-700">Ort</label>
                    <input type="text" class="w-full border rounded px-3 py-2" value="{{ termin.ort }}">
                </div>

                <div>
                    <label class="block font-medium text-gray-700">Start</label>
                    <input type="datetime-local" class="w-full border rounded px-3 py-2" value="{{ termin.start }}">
                </div>

                <div>
                    <label class="block font-medium text-gray-700">Ende</label>
                    <input type="datetime-local" class="w-full border rounded px-3 py-2" value="{{ termin.ende }}">
                </div>

            </div>
        </div>

        <!-- ================= Kontakte & Teilnehmer ================= -->
        <div class="bg-white rounded-md p-5 space-y-5">
            <h2 class="text-xl font-bold text-gray-800">Kontakte & Teilnehmer</h2>

            <div class="space-y-4 text-sm">

                <div>
                    <label class="block font-medium text-gray-700 mb-1">
                        Kontakt ausw√§hlen (bestehend)
                    </label>
                
                    <div class="flex gap-2">
                        <select id="kontaktSelect" class="flex-1 border rounded px-3 py-2">
                            <option value="-1">Kontakt ausw√§hlen‚Ä¶</option>
                            {% for kontakt in kontakte %}
                                <option value="{{ kontakt.id }}" data-ref-typ="{{ kontakt.ref_typ }}">{{ kontakt.referenz_data.name }}</option>
                            {% endfor %}
                        </select>
                
                        <button
                            id="kontaktAddBtn"
                            type="button"
                            class="px-4 py-2 rounded bg-[#4F81BD] text-white font-semibold hover:opacity-80 transition"
                        >
                            Hinzuf√ºgen
                        </button>
                        <p id="kontaktError" class="text-red-600 text-sm mt-1 hidden"></p>
                    </div>
                </div>

                <!-- Teilnehmer ListView -->
                <div>
                    <label class="block font-medium text-gray-700 mb-2">
                        Hinzugef√ºgte Kontakte
                    </label>

                    <div 
                        id="teilnehmerList"
                        class="border rounded-md divide-y bg-gray-50 text-sm"
                        data-alle-teilnehmer='{{ teilnehmer | tojson }}'>

                        {% for element in teilnehmer%}
                        <!-- Eintrag -->
                        <div 
                            class="flex items-center justify-between px-4 py-2"
                            data-kontakt-id="{{ element.kontakt.id }}"
                        >
                            <div class="flex items-center gap-3">
                                <input
                                    type="checkbox"
                                    class="teilnehmer-checkbox"
                                    {% if element.istHaupt == true %} checked="true" {% endif %}
                                >

                                <div>
                                    <p class="font-medium text-gray-800">{{ element.name }}</p>
                                    <p class="text-gray-500 text-xs">{{ element.kontakt.ref_typ }}</p>
                                </div>
                            </div>

                            <button
                                type="button"
                                class="text-red-500 hover:text-red-700 font-semibold remove-kontakt"
                            >
                                Entfernen
                            </button>
                        </div>
                        {% endfor %}

                    </div>
                </div>
            </div>
        </div>

        <!-- ================= Auftrag / Produkte ================= -->
        <div id="auftragDiv" class="bg-white rounded-md p-5 space-y-4" data-auftrag='{{ auftrag | tojson }}'>
            <h2 class="text-xl font-bold text-gray-800">
                Auftrag / Produkte (optional)
            </h2>
        
            <div class="space-y-4 text-sm">
        
                <!-- Produkt ausw√§hlen -->
                <div>
                    <label class="block font-medium text-gray-700 mb-1">
                        Produkt ausw√§hlen
                    </label>
                
                    <div class="flex gap-2">
                        <select 
                            id="produktSelect"
                            class="flex-1 border rounded px-3 py-2">
                            <option value="-1">Produkt ausw√§hlen‚Ä¶</option>
                            {% for produkt in produkte %}
                                <option value="{{ produkt.id }}" data-price="{{ produkt.price }}">{{ produkt.name }}</option>
                            {% endfor %}
                        </select>
                
                        <button
                            id="produktAddBtn"
                            type="button"
                            class="px-4 py-2 rounded bg-[#4F81BD] text-white font-semibold hover:opacity-80 transition"
                        >
                            Hinzuf√ºgen
                        </button>
                    </div>
                </div>
        
                <!-- Positionen ListView -->
                <div>
                    <label class="block font-medium text-gray-700 mb-2">
                        Positionen
                    </label>
                
                    <div id="positionList" class="border rounded-md divide-y"
                        data-alle-positionen='{{ positionen | tojson }}'>
                
                        <!-- Kopfzeile -->
                        <div class="grid grid-cols-5 gap-4 px-3 py-2 bg-gray-100 font-medium">
                            <span>Produkt</span>
                            <span>Menge</span>
                            <span class="text-right">Einzelpreis</span>
                            <span class="text-right">Gesamt</span>
                            <span class="text-right">Aktion</span>
                        </div>
                        
                
                        <!-- Position -->
                        {% for element in positionen %}
                        <div 
                            class="grid grid-cols-5 gap-4 px-3 py-2 items-center"
                            data-produkt-id="{{ element.produkt.id }}"
                        >
                            <span>{{ element.produkt.name }}</span>

                            <input
                                type="number"
                                min="1"
                                value="1"
                                class="w-20 border rounded px-2 py-1 menge-input"
                            >
                
                            <span class="text-right">{{ element.produkt.price }} ‚Ç¨</span>
                
                            <span
                                class="text-right position-gesamt"
                                data-position-gesamt="${preis}"
                            >
                                {{ element.produkt.price }} ‚Ç¨
                            </span>
                
                            <button
                                type="button"
                                class="text-red-500 hover:text-red-700 font-semibold text-sm remove-produkt"
                            >
                                Entfernen
                            </button>
                        </div>
                        {% endfor %}
                        <!-- Summenzeile -->
                        <div id="sumRow" class="grid grid-cols-5 gap-4 px-3 py-3 bg-gray-50 font-semibold">
                            <span class="col-span-4 text-right">
                                Gesamtpreis
                            </span>
                            <span id="gesamtPreis" class="text-right">
                                0 ‚Ç¨
                            </span>
                        </div>                        
                    </div>
                </div>
                
        
            </div>
        </div>
        

        <!-- ================= Aktionen ================= -->
        <div class="flex justify-center gap-4">
            <a href="/home">
                <button class="px-6 py-2 rounded bg-gray-600 text-white hover:opacity-80 transition">
                    Abbrechen
                </button>
            </a>
            <a href="/home">
                <button class="px-6 py-2 rounded bg-[#E74C3C] text-white hover:opacity-80 transition">
                    Termin l√∂schen
                </button>
            </a>
            <button onclick="saveTerminToBackend(1)" class="px-6 py-2 rounded bg-[#4F81BD] text-white font-semibold hover:opacity-80 transition">
                √Ñnderung speichern
            </button>
            <a href="/protocol/{{termin.id}}">
                <button class="px-6 py-2 rounded bg-[#4F81BD] text-white font-semibold hover:opacity-80 transition">
                    Protokoll schreiben
                </button>
            </a>
        </div>

    </section>
</main>
<script>
    const alleTeilnehmerRaw = document.getElementById("teilnehmerList").dataset.alleTeilnehmer;
    const allePositionenRaw = document.getElementById("positionList").dataset.allePositionen;
    const terminId = document.getElementById("terminDiv").dataset.terminId;
    const auftragDatenRaw = document.getElementById("auftragDiv").dataset.auftrag;

    const alleTeilnehmer = JSON.parse(alleTeilnehmerRaw);
    const allePositionen = JSON.parse(allePositionenRaw);
    const auftragDaten = JSON.parse(auftragDatenRaw);

    const kontaktSelect = document.getElementById("kontaktSelect");
    const kontaktAddBtn = document.getElementById("kontaktAddBtn");
    const teilnehmerList = document.getElementById("teilnehmerList");
    const errorBox = document.getElementById("kontaktError");
    
    function showError(msg) {
        errorBox.textContent = msg;
        errorBox.classList.remove("hidden");
    }
    
    function clearError() {
        errorBox.textContent = "";
        errorBox.classList.add("hidden");
    }
    
    function kontaktExists(id) {
        return !!teilnehmerList.querySelector(`[data-kontakt-id="${id}"]`);
    }
    
    kontaktAddBtn.addEventListener("click", () => {
        clearError();
    
        const option = kontaktSelect.options[kontaktSelect.selectedIndex];
    
        if (!option || !option.value || option.value=="-1") {
            showError("Bitte einen Kontakt ausw√§hlen.");
            return;
        }
    
        if (kontaktExists(option.value)) {
            showError("Dieser Kontakt wurde bereits hinzugef√ºgt.");
            return;
        }
    
        const row = document.createElement("div");
        row.className = "flex items-center justify-between px-4 py-2";
        row.dataset.kontaktId = option.value;
    
        const refTyp = option.dataset.refTyp || "Kontakt";

        row.innerHTML = `
            <div class="flex items-center gap-3">
                <input
                    type="checkbox"
                    class="teilnehmer-checkbox"
                >

                <div>
                    <p class="font-medium text-gray-800">${option.text}</p>
                    <p class="text-gray-500 text-xs">${refTyp}</p>
                </div>
            </div>

            <button
                type="button"
                class="text-red-500 hover:text-red-700 font-semibold remove-kontakt"
            >
                Entfernen
            </button>
        `;
    
        teilnehmerList.appendChild(row);
    });
    
    teilnehmerList.addEventListener("click", e => {
        if (e.target.classList.contains("remove-kontakt")) {
            e.target.closest("[data-kontakt-id]").remove();
        }
    });
    const produktSelect = document.getElementById("produktSelect");
    const produktAddBtn = document.getElementById("produktAddBtn");
    const positionList = document.getElementById("positionList");
    const gesamtPreisEl = document.getElementById("gesamtPreis");

    function produktExists(id) {
        return !!positionList.querySelector(`[data-produkt-id="${id}"]`);
    }

    function updateGesamtpreis() {
        let summe = 0;

        positionList.querySelectorAll("[data-position-gesamt]").forEach(el => {
            summe += parseFloat(el.dataset.positionGesamt);
        });

        gesamtPreisEl.textContent = summe.toFixed(2) + " ‚Ç¨";
    }

    produktAddBtn.addEventListener("click", () => {
        const option = produktSelect.options[produktSelect.selectedIndex];

        if (!option || option.value === "-1") {
            alert("Bitte ein Produkt ausw√§hlen.");
            return;
        }

        if (produktExists(option.value)) {
            alert("Dieses Produkt wurde bereits hinzugef√ºgt.");
            return;
        }

        const preis = parseFloat(option.dataset.price);

        const row = document.createElement("div");
        row.className = "grid grid-cols-5 gap-4 px-3 py-2 items-center";
        row.dataset.produktId = option.value;

        row.innerHTML = `
            <span>${option.text}</span>

            <input
                type="number"
                min="1"
                value="1"
                class="w-20 border rounded px-2 py-1 menge-input"
            >

            <span class="text-right">${preis.toFixed(2)} ‚Ç¨</span>

            <span
                class="text-right position-gesamt"
                data-position-gesamt="${preis}"
            >
                ${preis.toFixed(2)} ‚Ç¨
            </span>

            <button
                type="button"
                class="text-red-500 hover:text-red-700 font-semibold text-sm remove-produkt"
            >
                Entfernen
            </button>
        `;

        const sumRow = document.getElementById("sumRow");
        positionList.insertBefore(row, sumRow);

        updateGesamtpreis();
    });
    positionList.addEventListener("input", e => {
        if (!e.target.classList.contains("menge-input")) return;

        const row = e.target.closest("[data-produkt-id]");
        const preis = parseFloat(
            row.querySelector("span.text-right").textContent
        );

        const menge = parseInt(e.target.value || 1);
        const gesamt = preis * menge;

        const gesamtEl = row.querySelector(".position-gesamt");
        gesamtEl.textContent = gesamt.toFixed(2) + " ‚Ç¨";
        gesamtEl.dataset.positionGesamt = gesamt;

        updateGesamtpreis();
    });

    positionList.addEventListener("click", e => {
        if (e.target.classList.contains("remove-produkt")) {
            e.target.closest("[data-produkt-id]").remove();
            updateGesamtpreis();
        }
    });
    teilnehmerList.addEventListener("change", e => {
        if (!e.target.classList.contains("teilnehmer-checkbox")) return;

        // alle anderen Checkboxen deaktivieren
        teilnehmerList
            .querySelectorAll(".teilnehmer-checkbox")
            .forEach(cb => {
                if (cb !== e.target) cb.checked = false;
            });
    });

    function collectTerminData() {

        /* ================= Termindaten ================= */
        const terminartSelect = document.querySelector(
            'select'
        );

        const titelInput = document.querySelectorAll(
            'input[type="text"]'
        )[0];

        const ortInput = document.querySelectorAll(
            'input[type="text"]'
        )[1];

        const startInput = document.querySelectorAll(
            'input[type="datetime-local"]'
        )[0];

        const endeInput = document.querySelectorAll(
            'input[type="datetime-local"]'
        )[1];

        const terminart_id = terminartSelect?.value;
        const titel = titelInput?.value.trim();
        const ort = ortInput?.value.trim();
        const start = startInput?.value;
        const ende = endeInput?.value;

        /* ================= Validierung Termindaten ================= */
        if (!terminart_id || terminart_id === "Bitte ausw√§hlen") {
            throw new Error("Bitte eine Terminart ausw√§hlen.");
        }
        if (!titel) {
            throw new Error("Titel darf nicht leer sein.");
        }
        if (!ort) {
            throw new Error("Ort darf nicht leer sein.");
        }
        if (!start) {
            throw new Error("Startdatum fehlt.");
        }
        if (!ende) {
            throw new Error("Enddatum fehlt.");
        }
        if (new Date(start) > new Date(ende)) {
            throw new Error("Start darf nicht nach dem Ende liegen.");
        }

        /* ================= Kontakte ================= */
        const kontakte = [];
        document
            .querySelectorAll("#teilnehmerList [data-kontakt-id]")
            .forEach(row => {

                const kontaktId = parseInt(row.dataset.kontaktId);
                const checkbox = row.querySelector(".teilnehmer-checkbox");

                if (isNaN(kontaktId) || !checkbox) return;

                kontakte.push({
                    kontakt_id: kontaktId,
                    ausgewaehlt: checkbox.checked
                });
            });

        if (kontakte.length === 0) {
            throw new Error("Es muss mindestens ein Kontakt hinzugef√ºgt werden.");
        }

        /* ================= Produkte (optional) ================= */
        const produkte = [];
        document
            .querySelectorAll('#positionList [data-produkt-id]')
            .forEach(el => {
                const id = parseInt(el.dataset.produktId);
                if (!isNaN(id)) {
                    produkte.push(id);
                }
            });

        /* ================= Ergebnis ================= */
        return {
            termindaten: {
                terminart_id: parseInt(terminart_id),
                titel,
                ort,
                start,
                ende
            },
            kontakte,
            produkte
        };
    };

    async function saveTerminToBackend(uid) {
        try {
            const data = collectTerminData();

            /* ================= 1. TERMIN ================= */
            const terminRes = await fetch("http://127.0.0.1:5001/api/termine/"+terminId, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    title: data.termindaten.titel,
                    ort: data.termindaten.ort,
                    art_id: data.termindaten.terminart_id,
                    start: data.termindaten.start,
                    ende: data.termindaten.ende,
                    uid: uid
                })
            });

            if (!terminRes.ok) throw new Error("Termin konnte nicht erstellt werden");
            const termin = await terminRes.json();

            /* ================= 3. TEILNEHMER ================= */
            for (const teilnehmer of alleTeilnehmer) {
                await fetch("http://127.0.0.1:5001/api/teilnehmer/"+teilnehmer["id"], {
                    method: "DELETE",
                });
            }

            let haupt = "";

            for (const teilnehmer of data.kontakte) {
                if (teilnehmer.checkbox == true) [
                    haupt = teilnehmer
                ]
                console.log(teilnehmer.kontakt_id);
                console.log(terminId);
                console.log(teilnehmer.ausgewaehlt);

                await fetch("http://127.0.0.1:5001/api/teilnehmer", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        kontakt_id: teilnehmer.kontakt_id,
                        termin_id: terminId,
                        istHaupt: teilnehmer.ausgewaehlt
                    })
                }
            )}

            /* ================= 4. AUFTRAG + POSITIONEN (optional) ================= */
            if (data.produkte.length > 0) {

                // Auftrag ‚Üí erster Kontakt als Referenz
                const auftragRes = await fetch("http://127.0.0.1:5001/api/auftrag/"+auftragDaten.id, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        bezeichnung: `Termin ${terminId}`,
                        wichtigkeit_id: auftragDaten.wichtigkeit_id,      // Platzhalter
                        kontakt_id: haupt.kontakt_id
                    })
                });

                if (!auftragRes.ok) throw new Error("Auftrag konnte nicht erstellt werden");
                const auftrag = await auftragRes.json();

                // Auftragspositionen
                for (const position of allePositionen) {
                    await fetch("http://127.0.0.1:5001/api/auftragsposition/"+position.id, {
                        method: "DELETE"
                    });
                }

                for (const produktId of data.produkte) {
                    await fetch("http://127.0.0.1:5001/api/auftragsposition", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            auftrag_id: auftragDaten.id,
                            produkt_id: produktId
                        })
                    });
                }
            };

            // KI-Komponente rerank wichtigkeit

            alert("Termin erfolgreich gespeichert üéâ");

        } catch (err) {
            alert(err.message);
            console.error(err);
        }
    }
</script>
    

</body>
</html>
